configfile: "samples.yaml"

wildcard_constraints:
    sample='[a-zA-Z0-9]+'

print(f'Starting ChIP-seq data analysis workflow for samples: {config["samples"]}')

rule all:
    input:     
        expand("02_fastqc_analysis/{sample}_fastqc.html", sample=config["samples"]),
        expand("02_fastqc_analysis/{sample}_fastqc.zip", sample=config["samples"]),
        expand("06_macs2_peaks/{sample}_peaks.narrowPeak", sample=config["samples"]),
        expand("06_macs2_peaks/{sample}_peaks.xls", sample=config["samples"]),
        expand("06_macs2_peaks/{sample}_summits.bed", sample=config["samples"]),
        expand("06_macs2_peaks/{sample}_model.r", sample=config["samples"]),
        expand("06_macs2_peaks/{sample}_treat_pileup.bdg", sample=config["samples"]),
        expand("02_fastqc_analysis/{sample}.coorsorted.dedup_fastqc.html", sample=config["samples"]),
        expand("02_fastqc_analysis/{sample}.coorsorted.dedup_fastqc.zip", sample=config["samples"]),
        expand("05_bigwig_files/{sample}.bw", sample=config["samples"])

rule fastqc_precheck:
    input:
        expand("02_fastqc_analysis/{sample}_fastqc.html", sample=config["samples"]),
        expand("02_fastqc_analysis/{sample}_fastqc.zip", sample=config["samples"])

rule fastqc_precheck_wc:
    message: "Running quality control on samples pre-processing"
    input: "01_raw_data/{sample}.fastq.gz"
    output:
        "02_fastqc_analysis/{sample}_fastqc.html",
        "02_fastqc_analysis/{sample}_fastqc.zip"
    log: "00_logs/{sample}_fastqc_precheck_r1.log",
    shell: "fastqc {input} --outdir 02_fastqc_analysis/ 2> {log}"

rule align_reads:
    input: 
        expand("03_sam_files/{sample}.sam", sample=config["samples"])

rule align_reads_wc:
    message: "Aligning single end reads to reference genome"
    input:
        read = "01_raw_data/{sample}.fastq.gz",
        genome = multiext("01_raw_data/genome", ".amb", ".ann", ".bwt", ".pac", ".sa"),
    output: "03_sam_files/{sample}.sam"
    log: "00_logs/{sample}_align_reads_err.log"
    shell: "bwa mem 01_raw_data/genome {input.read} > {output} 2> {log}"
    
rule sam_to_bam:
    input: expand("04_bam_files/{sample}.bam", sample=config["samples"])
    
rule sam_to_bam_wc:
    message: "Converting SAM to BAM file format"
    input: "03_sam_files/{sample}.sam"
    output: "04_bam_files/{sample}.bam"
    log: "00_logs/{sample}_sam_to_bam.log"
    shell: "samtools view -b {input} > {output} 2> {log}"

rule sam_fixmate:
    input: expand("04_bam_files/{sample}.namesorted.fixmate.bam", sample=config["samples"])

rule sam_fixmate_wc:
    message: "Removing secondary and unmapped reads. Adding tags to reads for deduplication"
    input: "04_bam_files/{sample}.bam"
    output: "04_bam_files/{sample}.namesorted.fixmate.bam"
    log: "00_logs/{sample}_sam_fixmate.log"
    shell: "samtools fixmate -rcm -O bam {input} {output} 2> {log}"

rule sam_sort:
    input: expand("04_bam_files/{sample}.coorsorted.fixmate.bam", sample=config["samples"])
    
rule sam_sort_wc:
    message: "Sorting reads by chromosome coordinates"
    input: "04_bam_files/{sample}.namesorted.fixmate.bam"
    output: "04_bam_files/{sample}.coorsorted.fixmate.bam"
    log: "00_logs/{sample}_sam_sort.log"
    shell: "samtools sort {input} -o {output} 2> {log}"

rule sam_markdup:
    input: expand("04_bam_files/{sample}.coorsorted.dedup.bam", sample=config["samples"])

rule sam_markdup_wc:
    message: "Marking and removing duplicates"
    input: "04_bam_files/{sample}.coorsorted.fixmate.bam"
    output: "04_bam_files/{sample}.coorsorted.dedup.bam"
    log: "00_logs/{sample}_sam_markdup.log"
    shell: "samtools markdup -r --mode s {input} {output} 2> {log}"

rule sam_index:
    input: expand("04_bam_files/{sample}.coorsorted.dedup.bam.bai", sample=config["samples"])

rule sam_index_wc:
    message: "Indexing deduplicated BAM file"
    input: "04_bam_files/{sample}.coorsorted.dedup.bam"
    output: "04_bam_files/{sample}.coorsorted.dedup.bam.bai", 
    log: "00_logs/{sample}_sam_index.log"
    shell: "samtools index {input} 2> {log}"

rule bam_to_bigwig:
    input:
        expand("05_bigwig_files/{sample}.bw", sample=config["samples"])
        
rule bam_to_bigwig_wc:
    message: "Converting BAM file format to bigwig file format for visualization"
    input:
        index = "04_bam_files/{sample}.coorsorted.dedup.bam.bai",
        bam = "04_bam_files/{sample}.coorsorted.dedup.bam"
    output: "05_bigwig_files/{sample}.bw"
    log: "00_logs/{sample}_bam_to_bigwig.log"
    shell: "bamCoverage -b {input.bam} -o {output} 2> {log}"

rule call_peaks:
    input:
        expand("06_macs2_peaks/{sample}_peaks.narrowPeak", sample=config["samples"]),
        expand("06_macs2_peaks/{sample}_peaks.xls", sample=config["samples"]),
        expand("06_macs2_peaks/{sample}_summits.bed", sample=config["samples"]),
        expand("06_macs2_peaks/{sample}_model.r", sample=config["samples"]),
        expand("06_macs2_peaks/{sample}_treat_pileup.bdg", sample=config["samples"])

rule call_peaks_wc:
    message: "Calling ChIP-seq peaks"
    input: "04_bam_files/{sample}.coorsorted.dedup.bam"
    output: 
        "06_macs2_peaks/{sample}_peaks.narrowPeak", 
        "06_macs2_peaks/{sample}_peaks.xls",
        "06_macs2_peaks/{sample}_summits.bed", 
        "06_macs2_peaks/{sample}_model.r",
        "06_macs2_peaks/{sample}_treat_pileup.bdg"
    log: "00_logs/{sample}_macs2_peaks.log"
    shell: "macs2 callpeak -t {input} -f BAM -n {wildcards.sample} --bdg --outdir 06_macs2_peaks/ 2> {log}"

rule fastqc_postprocessing:
    input:
        expand("02_fastqc_analysis/{sample}.coorsorted.dedup_fastqc.html", sample=config["samples"]),
        expand("02_fastqc_analysis/{sample}.coorsorted.dedup_fastqc.zip", sample=config["samples"])

rule fastqc_postprocessing_wc:
    message: "Running quality control on samples post-processing"
    input: "04_bam_files/{sample}.coorsorted.dedup.bam"
    output:
        "02_fastqc_analysis/{sample}.coorsorted.dedup_fastqc.html",
        "02_fastqc_analysis/{sample}.coorsorted.dedup_fastqc.zip",
    log: "00_logs/{sample}_fastqc_postprocessing.log",
    shell: "fastqc {input} --outdir 02_fastqc_analysis/ 2> {log}"  
