def sample_group(wildcards):
	group = config["samples"][wildcards.sample]
	return expand("04_bam_files/{sample}.sorted.dedup.bam", sample = group)

def sample_index_group(wildcards):
	group = config["samples"][wildcards.sample]
	return expand("04_bam_files/{sample}.sorted.dedup.bam.bai", sample = group)

def control_group(wildcards):
	group = config["controls"][wildcards.control]
	return expand("04_bam_files/{sample}.sorted.dedup.bam", sample = group)

def control_index_group(wildcards):
	group = config["controls"][wildcards.control]
	return expand("04_bam_files/{sample}.sorted.dedup.bam.bai", sample = group)
		
rule call_peaks:
	input:
		s = sample_group,
		c = control_group,
		si = sample_index_group,
		ci = control_index_group
	output: "06_pepr_peaks/{sample}_{control}__PePr_parameters.txt"
	log: "00_logs/{sample}_{control}_pepr_peaks.log"
	run:
		sample_input = ','.join(input.s)
		control_input = ','.join(input.c)
		
		shell("PePr -f PEPR_READ_TYPE --peaktype PEPR_PEAK_TYPE --num-processors THREADS "
			"-c {sample_input} -i {control_input} --output-directory 06_pepr_peaks "
			"-n {wildcards.sample}_{wildcards.control} 2> {log}")
