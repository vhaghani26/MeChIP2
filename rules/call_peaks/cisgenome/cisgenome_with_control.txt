'''
expand("cisgenome_peaks/{sample}_{control}_peak.cod",
	sample=config["sample_groups"], control=config["control_groups"])
'''

rule bam_to_sam:
	input:
		"bam_files/{sample}.sorted.dedup.bam"
	output:
		"aligned_reads/{sample}.sorted.dedup.sam"
	shell:
		"samtools view -@ THREADS {input} > {output}"
		
rule sam_to_aln:
	input:
		"aligned_reads/{sample}.sorted.dedup.sam"
	output:
		"cisgenome_files/{sample}.aln"
	shell:
		"./sam2aln -i {input} > {output}"

def get_sample_groups(wildcards):
	if len(wildcards.sample.split('_')) == 1:
		return "cisgenome_files/{sample}.aln"
	else:
		exp = wildcards.sample.split('_')
		return expand("cisgenome_files/{sample}.aln", sample=exp)

def get_control_groups(wildcards):
	if len(wildcards.control.split('_')) == 1:
		return "cisgenome_files/{control}.aln"
	else:
		exp = wildcards.control.split('_')
		return expand("cisgenome_files/{control}.aln", sample=exp)
		
rule write_filelist:
	input:
		s = get_sample_groups,
		c = get_control_groups
	output:
		"cisgenome_files/{sample}_{control}_filelist.txt"
	run:
		if type(input.s) is snakemake.io.Namedlist:
			for sample in input.s:
				shell("echo \'{sample}\t1\' >> {output}")
		else:
			shell("echo \'{input.s}\t1\' >> {output}")
		if type(input.c) is snakemake.io.Namedlist:
			for control in input.c:
				shell("echo \'{control}\t0\' >> {output}")
		else:
			shell("echo \'{input.c}\t0\' >> {output}")

rule call_peaks:	
	input:
		"cisgenome_files/{sample}_{control}_filelist.txt"
	output:
		multiext("cisgenome_peaks/{sample}_{control}", "_peak.cod", "_log2fc.bar",
			"_t.bar")
	shell:
		"seqpeak -i {input} -d cisgenome_peaks -o {wildcards.sample}_{wildcards.control}"
